{% extends "base.html" %}
{% load static %}
{% load dict_extras %}
{% load form_extras %}

{% block titles %}
    Techlink | Seu Perfil
{% endblock %}


{% block styles %}

{% endblock %}


{% block content %}

<main class="w-full flex flex-col items-center">
  <div class="h-[280px] w-full absolute px-4" style="background-color: #FDFCF6;">
    <div class="w-full flex flex-col mx-auto bg-white border border-gray-300 relative top-25 max-w-[1320px] mx-4">
      <div class="flex lg:justify-between flex-col lg:flex-row items-center py-6 px-10 gap-4 lg:gap-0">
        <div class="flex gap-5 items-center">
          {% if usuario.foto_perfil %}
            <img src="{{ usuario.foto_perfil.url }}" alt="Imagem perfil" class="h-[100px] w-[100px] rounded-full object-cover">
          {% else %}
            <img src="{% static 'img/default-avatar.jpg' %}" alt="Imagem perfil" class="h-[100px] w-[100px] rounded-full object-cover">
          {% endif %}
          
          <span class="text-gray-900 text-xl font-semibold">{{usuario.nome}} {{usuario.sobrenome}}</span>
        </div>
        <div>
          <button class="bg-red-100 text-red-800 py-4 px-6 font-semibold flex gap-3 items-center cursor-pointer hover:bg-red-400 transition duration-300">Seja um instrutor <i class="fa-solid fa-arrow-right" style="color: #9E0000;"></i></button>
        </div>
      </div>

      <div class="flex items-center w-full justify-center border-b border-t border-gray-200 md:gap-32 gap-8">
            <button class="tab-button text-gray-500 font-medium py-3 px-6 border-b-2 border-transparent transition-colors duration-300 cursor-pointer">
                Instrutores
            </button>
            
            <button class="tab-button text-gray-900 font-medium py-3 px-6 border-b-2 border-red-500 transition-colors duration-300 cursor-pointer">
                Configurações
            </button>
      </div>
      
    </div>
  </div>

  <div class="w-full flex justify-center flex-col mt-[420px] lg:mt-[350px] max-w-[1320px] px-4 mb-8">
    <h2 class="font-semibold text-gray-900 text-3xl mb-8">Configurações</h2>
    
    <div class="flex flex-col lg:flex-row gap-12 w-full items-start">       

      <!-- Formulário dos dados do usuário -->
      <form method="post" enctype="multipart/form-data" class="flex-1 w-full">
        {% csrf_token %}
        <div class="flex flex-col md:flex-row gap-8 w-full">
            <!-- Coluna da foto -->
            <div class="flex flex-col items-center md:w-1/3">
                <div class="image-upload-container">
                    <div class="relative">
                        <img 
                            id="image-preview"
                            src="{% if usuario.foto_perfil %}{{ usuario.foto_perfil.url }}{% else %}{% static 'img/default-avatar.jpg' %}{% endif %}" 
                            alt="Foto de Perfil"
                            class="profile-pic mb-2">

                        <label for="{{ profile_form.foto_perfil.id_for_label }}" class="upload-label">
                            <i class="fa-solid fa-arrow-up-from-bracket"></i> <span>Escolher foto</span>
                        </label>

                        <input type="file"
                            accept="image/*"
                            name="{{ profile_form.foto_perfil.name }}"
                            id="{{ profile_form.foto_perfil.id_for_label }}"
                            class="hidden-file-input"
                            onchange="previewImage(this)">
                    </div>
                    {% if profile_form.foto_perfil.errors %}
                        <p class="text-red-600 text-sm mt-2">{{ profile_form.foto_perfil.errors }}</p>
                    {% endif %}
                </div>
            </div>
            <!-- Coluna dos demais campos -->
            <div class="flex-1">
                <div class="flex gap-6 mb-4">
                    <div class="flex-1">
                        <label for="{{ profile_form.nome.id_for_label }}" class="text-gray-900">Nome</label>
                        {{ profile_form.nome }}
                        {% if profile_form.nome.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ profile_form.nome.errors.as_text }}</p>
                        {% endif %}
                    </div>
                    <div class="flex-1">
                        <label for="{{ profile_form.sobrenome.id_for_label }}" class="text-gray-900">Sobrenome</label>
                        {{ profile_form.sobrenome }}
                        {% if profile_form.sobrenome.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ profile_form.sobrenome.errors.as_text }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="mb-4">
                    <label for="{{ profile_form.num_celular.id_for_label }}" class="text-gray-900">Telefone</label>
                    {{ profile_form.num_celular }}
                    {% if profile_form.num_celular.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ profile_form.num_celular.errors.as_text }}</p>
                    {% endif %}
                </div>
                <div class="mb-6">
                    <label for="{{ profile_form.email.id_for_label }}" class="text-gray-900">Email</label>
                    {{ profile_form.email }}
                    {% if profile_form.email.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ profile_form.email.errors.as_text }}</p>
                    {% endif %}
                </div>
                <button type="submit" name="submit_perfil" class="py-4 px-6 bg-red-900 text-white font-medium flex gap-3 items-center cursor-pointer hover:bg-red-800 transition duration-300">
                    Salvar
                </button>
            </div>
        </div>
    </form>

    </div>
  </div>

  <div class="w-full flex flex-col justify-start max-w-[1320px] px-4 mb-16">
    <h2 class="font-semibold text-gray-900 text-3xl mb-8">Mudar Senha</h2>

    <form method="post" class="lg:w-1/2">
      {% csrf_token %}

      <div class="flex flex-col">
          <label for="{{ password_form.old_password.id_for_label }}" class="text-gray-900">Senha Atual</label>
              {{password_form.old_password }}
              {% if password_form.old_password.errors %}
                <p class="text-red-500 text-sm mt-1">{{ password_form.old_password.errors.as_text }}</p>
              {% endif %}
      </div>

      <div class="flex flex-col">
          <label for="{{ password_form.new_password1.id_for_label }}" class="text-gray-900">Nova Senha</label>
              {{ password_form.new_password1 }}
              {% if password_form.new_password1.errors %}
                <p class="text-red-500 text-sm mt-1">{{ password_form.new_password1.as_text }}</p>
              {% endif %}
      </div>

      
      <div class="flex flex-col">
          <label for="{{ password_form.new_password2.id_for_label }}" class="text-gray-900">Confirme a Senha</label>
              {{ password_form.new_password2 }}
              {% if password_form.new_password2.errors %}
                <p class="text-red-500 text-sm mt-1">{{ password_form.new_password2.errors.as_text }}</p>
              {% endif %}
      </div>

      <button type="submit" name="submit_senha" class="py-4 px-6 bg-red-900 text-white font-medium flex gap-3 items-center cursor-pointer hover:bg-red-800 transition duration-300">Mudar Senha</button>
    </form>

  </div>

  <!-- Formulário de dados de professor -->
    <div class="w-full flex flex-col justify-start max-w-[1320px] px-4 mb-16">
      <h2 class="font-semibold text-gray-900 text-3xl mb-8">Editar Perfil de Professor</h2>

      <form method="post" class="lg:w-1/2">
        {% csrf_token %}
        {{ professor_form.non_field_errors }}

        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700">Apresentação:</label>
          {{ professor_form.apresentacao }}
          {{ professor_form.apresentacao.errors }}
        </div>

        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700">Valor Hora:</label>
          {{ professor_form.valor_hora }}
          {{ professor_form.valor_hora.errors }}
        </div>

        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700">Temas</label>
          <div id="temas-container">
            <div class="tema-input flex items-center gap-2 mb-2">
              <input type="text" id="novo-tema-input" class="tema-field border border-gray-300 p-2" placeholder="Digite um tema">
              <button type="button" id="add-tema-btn" class="bg-red-800 text-white py-2 px-3 cursor-pointer">+</button>
            </div>
          </div>
          {% if temas_error %}
            <p class="text-red-600 text-sm">{{ temas_error }}</p>
          {% endif %}

          <ul id="temas-list" class="flex flex-wrap gap-2">
            {% for tema in professor_form.instance.temas.all %}
              <li class="bg-green-200 px-3 py-1 rounded-full text-gray-800 text-sm flex items-center gap-2" data-tema-id="{{ tema.id }}">
                {{ tema.nome }}
                <button type="button" class="ml-2 text-red-600 hover:text-red-800 remove-tema-salvo-btn" title="Remover tema">
                  <i class="fa-solid fa-xmark"></i>
                </button>
                <input type="hidden" name="temas_salvos[]" value="{{ tema.id }}">
              </li>
            {% empty %}
              <li class="text-gray-500">Nenhum tema cadastrado.</li>
            {% endfor %}
          </ul>
        </div>

        <div class="pt-4">
          <button type="submit" name="submit_professor" class="bg-red-800 text-white py-2 px-4 cursor-pointer hover:bg-red-900">Salvar Perfil de Professor</button>
        </div>
      </form>
    </div>

    <!-- Formulário de horários disponíveis -->
    <div class="w-full flex flex-col justify-start max-w-[1320px] px-4 mb-12 mt-12">
      <h2 class="font-semibold text-gray-900 text-2xl mb-6">Disponibilidade de Horários</h2>
      <form method="post">
        {% csrf_token %}
        <div class="overflow-x-auto">
          <table class="mb-6 w-full min-w-[600px] border-separate border-spacing-3 text-sm md:text-base">
            <thead>
              <tr>
                <th class="px-6 py-3">Horário</th>
                {% for dia in form.dias %}
                  <th class="px-6 py-3">{{ dia|date:"d/m" }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for hora in form.horarios %}
                <tr>
                  <td class="px-6 py-3 whitespace-nowrap">{{ hora }}</td>
                  {% for dia in form.dias %}
                    <td class="px-6 py-3 text-center align-middle">
                      {% with nome=dia|stringformat:"s"|add:"|"|add:hora %}
                        {{ form|field_by_name:nome }}
                      {% endwith %}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <button type="submit" name="submit_horarios" class="bg-red-800 text-white py-2 px-4 rounded hover:bg-red-900 mt-4">Salvar Disponibilidade</button>
      </form>
    </div>

    <h2 class="font-semibold text-gray-900 text-2xl mt-8 mb-4">Horários Agendados</h2>
    <tbody>
      {% for aula in aulas_agendadas %}
        <tr>
          <td class="border px-2 py-1">{{ aula.horario.data|date:"d/m/Y" }}</td>
          <td class="border px-2 py-1">{{ aula.horario.hora }}</td>
          <td class="border px-2 py-1">
            {{ aula.aluno.usuario.nome }} {{ aula.aluno.usuario.sobrenome }}
          </td>
          <td class="border px-2 py-1">
            {{ aula.aluno.usuario.email }}
          </td>
          <td class="border px-2 py-1">
            <span class="font-semibold">
              {% if aula.status == 'agendada' %}Agendada
              {% elif aula.status == 'realizada' %}Concluída
              {% else %}Cancelada
              {% endif %}
            </span>
          </td>
          <td class="border px-2 py-1">
            {% if aula.status == 'agendada' %}
              <form method="post" action="{% url 'agendamentos:marcar_aula_concluida' aula.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="text-green-700 hover:underline">Concluir</button>
              </form>
              <form method="post" action="{% url 'agendamentos:cancelar_aula' aula.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="text-red-700 hover:underline">Cancelar</button>
              </form>
            {% elif aula.status == 'realizada' or aula.status == 'cancelada' %}
              <form method="post" action="{% url 'agendamentos:excluir_aula' aula.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="text-gray-500 hover:text-red-700 hover:underline">Excluir</button>
              </form>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="6" class="border px-2 py-1 text-center text-gray-500">Nenhum horário agendado.</td>
        </tr>
      {% endfor %}
    </tbody>
    </div>
</main>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Preview da imagem de perfil
    const fileInput = document.getElementById('{{ profile_form.foto_perfil.id_for_label }}');
    const imagePreview = document.getElementById('image-preview');
    if (fileInput && imagePreview) {
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Tabs de navegação
    const tabButtons = document.querySelectorAll('.tab-button');
    const activeClasses = ['border-red-500', 'text-gray-900'];
    const inactiveClasses = ['border-transparent', 'text-gray-500'];
    tabButtons.forEach(clickedButton => {
        clickedButton.addEventListener('click', () => {
            tabButtons.forEach(button => {
                button.classList.remove(...activeClasses);
                button.classList.add(...inactiveClasses);
            });
            clickedButton.classList.remove(...inactiveClasses);
            clickedButton.classList.add(...activeClasses);
        });
    });

    // Adicionar temas dinamicamente à lista (não salvos ainda)
    const addTemaBtn = document.getElementById('add-tema-btn');
    const novoTemaInput = document.getElementById('novo-tema-input');
    const temasList = document.getElementById('temas-list');

    addTemaBtn.addEventListener('click', function() {
        const tema = novoTemaInput.value.trim();
        if (tema) {
            // Cria o elemento li com fundo vermelho
            const li = document.createElement('li');
            li.className = 'bg-red-200 px-3 py-1 rounded-full text-gray-800 text-sm flex items-center gap-2';
            li.innerHTML = `
                ${tema}
                <button type="button" class="ml-2 text-red-600 hover:text-red-800 remove-tema-btn" title="Remover tema">
                  <i class="fa-solid fa-xmark"></i>
                </button>
                <input type="hidden" name="temas[]" value="${tema}">
            `;
            temasList.appendChild(li);
            novoTemaInput.value = '';
        }
    });

    // Remover temas adicionados dinamicamente (não salvos)
    temasList.addEventListener('click', function(e) {
        if (e.target.closest('.remove-tema-btn')) {
            e.target.closest('li').remove();
        }
    });
    // Remover temas já salvos (marcar para remoção)
    temasList.addEventListener('click', function(e) {
        if (e.target.closest('.remove-tema-salvo-btn')) {
            const li = e.target.closest('li');
            // Adiciona um campo hidden para indicar remoção
            const temaId = li.getAttribute('data-tema-id');
            const inputRemover = document.createElement('input');
            inputRemover.type = 'hidden';
            inputRemover.name = 'remover_temas[]';
            inputRemover.value = temaId;
            li.appendChild(inputRemover);
            // Esconde o tema visualmente
            li.style.display = 'none';
        }
        if (e.target.closest('.remove-tema-btn')) {
            e.target.closest('li').remove();
        }
    });

  });
  </script>
{% endblock %}

